name: TUI Tests

on:
  pull_request:
    paths-ignore:
      - '**/*.md'
      - 'docs/**'
      - 'examples/**'
      - 'LICENSE'

concurrency:
  group: tui-tests-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
  changes:
    runs-on: ubuntu-latest
    outputs:
      cli: ${{ steps.filter.outputs.cli }}
      shared: ${{ steps.filter.outputs.shared }}
      tui: ${{ steps.filter.outputs.tui }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Detect changes
        id: filter
        uses: dorny/paths-filter@v3
        with:
          filters: |
            shared:
              - 'package.json'
              - 'package-lock.json'
              - 'vitest.config.ts'
              - '.github/workflows/**'
            cli:
              - 'src/cli.ts'
              - 'src/commands/**'
              - 'src/utils/**'
              - 'src/database.ts'
              - 'src/jsonl.ts'
              - 'src/sync/**'
              - 'src/github*.ts'
              - 'src/types.ts'
              - 'src/index.ts'
              - 'tests/cli.test.ts'
              - 'tests/**/*.test.ts'
              - 'test/**/*.test.ts'
            tui:
              - 'src/commands/tui.ts'
              - 'src/tui/**'
              - 'tests/tui/**/*.test.ts'
              - 'test/tui-*.test.ts'
              - 'tests/tui-ci-run.sh'
              - 'vitest.tui.config.ts'
              - 'Dockerfile.tui-tests'
              - 'test-tui.sh'

  cli-tests:
    runs-on: ubuntu-latest
    needs: changes
    if: ${{ needs.changes.outputs.cli == 'true' || needs.changes.outputs.shared == 'true' }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Build CLI
        run: npm run build

      - name: Run CLI tests
        run: npm test

  tui-tests:
    runs-on: ubuntu-latest
    needs: changes
    if: ${{ needs.changes.outputs.tui == 'true' || needs.changes.outputs.shared == 'true' }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Run headless TUI tests
        run: bash ./tests/tui-ci-run.sh
